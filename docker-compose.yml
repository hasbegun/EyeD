services:
  postgres:
    image: postgres:16
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./config/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      POSTGRES_DB: eyed
      POSTGRES_USER: eyed
      POSTGRES_PASSWORD: eyed_dev
    ports:
      - "9506:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U eyed -d eyed"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "9508:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  nats:
    image: nats:2.10
    ports:
      - "9502:4222"    # NATS client
      - "9501:8222"    # NATS monitoring
    command: --config /etc/nats/nats-server.conf
    volumes:
      - ./config/nats-server.conf:/etc/nats/nats-server.conf:ro

  iris-engine:
    build:
      context: ./iris-engine
      args:
        RUNTIME: cpu
    ports:
      - "9500:7000"
    depends_on:
      nats:
        condition: service_started
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./data:/data:ro
    environment:
      EYED_RUNTIME: cpu
      EYED_NATS_URL: nats://nats:4222
      EYED_DB_URL: postgresql://eyed:eyed_dev@postgres:5432/eyed
      EYED_REDIS_URL: redis://redis:6379/0
      EYED_ENCRYPTION_KEY: ""   # 64 hex chars to enable template encryption
      EYED_LOG_LEVEL: info
      OMP_NUM_THREADS: "2"
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request,json; d=json.load(urllib.request.urlopen('http://localhost:7000/health/ready')); exit(0 if d.get('ready') else 1)"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 60s

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    ports:
      - "9503:50051"   # gRPC (capture devices)
      - "9504:8080"    # HTTP health (+ future WebSocket)
    depends_on:
      - nats
    environment:
      EYED_NATS_URL: nats://nats:4222
      EYED_LOG_LEVEL: info

  capture-device:
    build:
      context: .
      dockerfile: capture/Dockerfile
    profiles: [capture]          # Only start with: docker compose --profile capture up -d
    depends_on:
      - gateway
    volumes:
      - ./data:/data:ro
    environment:
      EYED_GATEWAY_ADDR: gateway:50051
      EYED_DEVICE_ID: capture-01
      EYED_LOG_LEVEL: info
      EYED_IMAGE_DIR: /data/Iris/CASIA1
      EYED_QUALITY_THRESHOLD: "0.05"
    restart: unless-stopped

  storage:
    build:
      context: .
      dockerfile: storage/Dockerfile
    ports:
      - "9507:8082"    # HTTP health
    depends_on:
      - nats
    volumes:
      - archive-data:/data/archive
    environment:
      EYED_NATS_URL: nats://nats:4222
      EYED_ARCHIVE_ROOT: /data/archive
      EYED_LOG_LEVEL: info

  client:
    build:
      context: ./client
    ports:
      - "9505:80"
    depends_on:
      - gateway
      - iris-engine

  integration-test:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    profiles: [test]
    depends_on:
      gateway:
        condition: service_started
      iris-engine:
        condition: service_healthy
    volumes:
      - ./data:/data:ro
    entrypoint: /app/integration-test
    command:
      - -gateway=gateway:50051
      - -nats=nats://nats:4222
      - -image=/data/Iris/CASIA1/1/001_1_1.jpg
      - -timeout=120s

volumes:
  pgdata:
  archive-data:
